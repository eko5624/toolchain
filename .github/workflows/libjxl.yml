name: libjxl
defaults:
  run:
    shell: bash
on:
  workflow_dispatch:
  
jobs:
  brotli:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:base-devel
    steps:    
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git yasm nasm ninja cmake python-pip curl python-cairo unzip p7zip curl jq
          pip3 install -U --break-system-packages setuptools rst2pdf mako jsonschema meson
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true
          git config --global rebase.autoStash true
          git config --global fetch.prune true
          git config --global --add safe.directory $PWD
      - name: Add builder user
        run: |
          useradd builder -m
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
      - name: Setting top_dir env
        run: |
           echo "top_dir=$(cd ~ && pwd)" >> $GITHUB_ENV         
      - name: Checkout
        run: |
          cd ${{ env.top_dir }}
          git clone https://github.com/eko5624/toolchain-test        
      - name: Setting makepkg etc
        run: |
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg_cross.conf /etc
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg-cross /usr/local/bin
          sudo chmod +x /usr/local/bin/makepkg-cross
      - name: Loading cross gcc cache
        uses: actions/cache/restore@main
        with:
          path: ${{ env.top_dir }}/cross
          key: cross-gcc-mcf-${{ github.run_id }}
          restore-keys: |
            cross-gcc-mcf-
      - name: Build
        run: |
          export PATH="${{ env.top_dir }}/cross/bin:$PATH"
          export PKG_CONFIG_LIBDIR="${{ env.top_dir }}/opt/lib/pkgconfig"
          export PKG_CONFIG="pkgconf --static"

          sudo chmod 777 -R ${{ env.top_dir }}
          cd ${{ env.top_dir }}/toolchain-test/brotli-dev
          sudo -H -u builder makepkg-cross -sC --noconfirm
      - name: Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd ${{ env.top_dir }}/toolchain-test
          chmod +x ./release-dev.sh
          ./release-dev.sh brotli-dev brotli-dev
          
  highway:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:base-devel
    steps:    
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git yasm nasm ninja cmake python-pip curl python-cairo unzip p7zip curl jq
          pip3 install -U --break-system-packages setuptools rst2pdf mako jsonschema meson
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true
          git config --global rebase.autoStash true
          git config --global fetch.prune true
          git config --global --add safe.directory $PWD
      - name: Add builder user
        run: |
          useradd builder -m
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
      - name: Setting top_dir env
        run: |
           echo "top_dir=$(cd ~ && pwd)" >> $GITHUB_ENV         
      - name: Checkout
        run: |
          cd ${{ env.top_dir }}
          git clone https://github.com/eko5624/toolchain-test
      - name: Setting makepkg etc
        run: |
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg_cross.conf /etc
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg-cross /usr/local/bin
          sudo chmod +x /usr/local/bin/makepkg-cross
      - name: Loading cross gcc cache
        uses: actions/cache/restore@main
        with:
          path: ${{ env.top_dir }}/cross
          key: cross-gcc-mcf-${{ github.run_id }}
          restore-keys: |
            cross-gcc-mcf-
      - name: Build
        run: |
          export PATH="${{ env.top_dir }}/cross/bin:$PATH"
          export PKG_CONFIG_LIBDIR="${{ env.top_dir }}/opt/lib/pkgconfig"
          export PKG_CONFIG="pkgconf --static"
          
          sudo chmod 777 -R ${{ env.top_dir }}
          cd ${{ env.top_dir }}/toolchain-test/highway-dev
          sudo -H -u builder makepkg-cross -sC --noconfirm
      - name: Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd ${{ env.top_dir }}/toolchain-test
          chmod +x ./release-dev.sh
          ./release-dev.sh highway-dev highway-dev
          
  lcms2:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:base-devel
    steps:    
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git yasm nasm ninja cmake python-pip curl python-cairo unzip p7zip curl jq
          pip3 install -U --break-system-packages setuptools rst2pdf mako jsonschema meson
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true
          git config --global rebase.autoStash true
          git config --global fetch.prune true
          git config --global --add safe.directory $PWD
      - name: Add builder user
        run: |
          useradd builder -m
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
      - name: Setting top_dir env
        run: |
           echo "top_dir=$(cd ~ && pwd)" >> $GITHUB_ENV         
      - name: Checkout
        run: |
          cd ${{ env.top_dir }}
          git clone https://github.com/eko5624/toolchain-test
      - name: Setting makepkg etc
        run: |
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg_cross.conf /etc
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg-cross /usr/local/bin
          sudo chmod +x /usr/local/bin/makepkg-cross
      - name: Loading cross gcc cache
        uses: actions/cache/restore@main
        with:
          path: ${{ env.top_dir }}/cross
          key: cross-gcc-mcf-${{ github.run_id }}
          restore-keys: |
            cross-gcc-mcf-
      - name: Build
        run: |
          export PATH="${{ env.top_dir }}/cross/bin:$PATH"
          export PKG_CONFIG_LIBDIR="${{ env.top_dir }}/opt/lib/pkgconfig"
          export PKG_CONFIG="pkgconf --static"

          sudo chmod 777 -R ${{ env.top_dir }}
          cd ${{ env.top_dir }}/toolchain-test/lcms2-dev
          sudo -H -u builder makepkg-cross -sC --noconfirm
      - name: Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd ${{ env.top_dir }}/toolchain-test
          chmod +x ./release-dev.sh
          ./release-dev.sh lcms2-dev lcms2-dev
          
  libjpeg:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:base-devel
    steps:    
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git yasm nasm ninja cmake python-pip curl python-cairo unzip p7zip curl jq
          pip3 install -U --break-system-packages setuptools rst2pdf mako jsonschema meson
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true
          git config --global rebase.autoStash true
          git config --global fetch.prune true
          git config --global --add safe.directory $PWD
      - name: Add builder user
        run: |
          useradd builder -m
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
      - name: Setting top_dir env
        run: |
           echo "top_dir=$(cd ~ && pwd)" >> $GITHUB_ENV         
      - name: Checkout
        run: |
          cd ${{ env.top_dir }}
          git clone https://github.com/eko5624/toolchain-test
      - name: Setting makepkg etc
        run: |
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg_cross.conf /etc
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg-cross /usr/local/bin
          sudo chmod +x /usr/local/bin/makepkg-cross
      - name: Loading cross gcc cache
        uses: actions/cache/restore@main
        with:
          path: ${{ env.top_dir }}/cross
          key: cross-gcc-mcf-${{ github.run_id }}
          restore-keys: |
            cross-gcc-mcf-
      - name: Build
        run: |
          export PATH="${{ env.top_dir }}/cross/bin:$PATH"
          export PKG_CONFIG_LIBDIR="${{ env.top_dir }}/opt/lib/pkgconfig"
          export PKG_CONFIG="pkgconf --static"

          sudo chmod 777 -R ${{ env.top_dir }}
          cd ${{ env.top_dir }}/toolchain-test/libjpeg-dev
          sudo -H -u builder makepkg-cross -sC --noconfirm
      - name: Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd ${{ env.top_dir }}/toolchain-test
          chmod +x ./release-dev.sh
          ./release-dev.sh libjpeg-dev libjpeg-dev
          
  libjxl:
    needs: [brotli, highway, lcms2, libjpeg]
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:base-devel
    steps:    
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git yasm nasm ninja cmake python-pip curl python-cairo unzip p7zip curl jq
          pip3 install -U --break-system-packages setuptools rst2pdf mako jsonschema meson
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true
          git config --global rebase.autoStash true
          git config --global fetch.prune true
          git config --global --add safe.directory $PWD
      - name: Add builder user
        run: |
          useradd builder -m
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
      - name: Setting top_dir env
        run: |
           echo "top_dir=$(cd ~ && pwd)" >> $GITHUB_ENV         
      - name: Checkout
        run: |
          cd ${{ env.top_dir }}
          git clone https://github.com/eko5624/toolchain-test
      - name: Setting makepkg etc
        run: |
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg_cross.conf /etc
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg-cross /usr/local/bin
          sudo chmod +x /usr/local/bin/makepkg-cross
      - name: Loading cross gcc cache
        uses: actions/cache/restore@main
        with:
          path: ${{ env.top_dir }}/cross
          key: cross-gcc-mcf-${{ github.run_id }}
          restore-keys: |
            cross-gcc-mcf-
      - name: Build
        run: |
          export PATH="${{ env.top_dir }}/cross/bin:$PATH"
          export PKG_CONFIG_LIBDIR="${{ env.top_dir }}/opt/lib/pkgconfig"
          export PKG_CONFIG="pkgconf --static"

          cd ${{ env.top_dir }}
          curl -OL https://github.com/${{ github.repository }}/releases/download/dev/brotli-dev-1.0.9-1-x86_64.pkg.tar.zst
          curl -OL https://github.com/${{ github.repository }}/releases/download/dev/highway-dev-1.0.5-1-x86_64.pkg.tar.zst
          curl -OL https://github.com/${{ github.repository }}/releases/download/dev/lcms2-dev-2.15-1-x86_64.pkg.tar.zst
          curl -OL https://github.com/${{ github.repository }}/releases/download/dev/libjpeg-dev-3.0.0-1-x86_64.pkg.tar.zst
          pacman -U *.zst --noconfirm
          sudo chmod 777 -R ${{ env.top_dir }}
          cd ${{ env.top_dir }}/toolchain-test/libjxl-dev
          sudo -H -u builder makepkg-cross -sC --noconfirm
      - name: Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd ${{ env.top_dir }}/toolchain-test
          chmod +x ./release-dev.sh
          ./release-dev.sh libjxl-dev libjxl-dev
          
  libpng:
    needs: [zlib]
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:base-devel
    steps:    
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git yasm nasm ninja cmake python-pip curl python-cairo unzip p7zip curl jq
          pip3 install -U --break-system-packages setuptools rst2pdf mako jsonschema meson
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true
          git config --global rebase.autoStash true
          git config --global fetch.prune true
          git config --global --add safe.directory $PWD
      - name: Add builder user
        run: |
          useradd builder -m
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
      - name: Setting top_dir env
        run: |
           echo "top_dir=$(cd ~ && pwd)" >> $GITHUB_ENV         
      - name: Checkout
        run: |
          cd ${{ env.top_dir }}
          git clone https://github.com/eko5624/toolchain-test
      - name: Setting makepkg etc
        run: |
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg_cross.conf /etc
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg-cross /usr/local/bin
          sudo chmod +x /usr/local/bin/makepkg-cross
      - name: Loading cross gcc cache
        uses: actions/cache/restore@main
        with:
          path: ${{ env.top_dir }}/cross
          key: cross-gcc-mcf-${{ github.run_id }}
          restore-keys: |
            cross-gcc-mcf-
      - name: Build
        run: |
          export PATH="${{ env.top_dir }}/cross/bin:$PATH"
          export PKG_CONFIG_LIBDIR="${{ env.top_dir }}/opt/lib/pkgconfig"
          export PKG_CONFIG="pkgconf --static"

          cd ${{ env.top_dir }}
          curl -OL https://github.com/${{ github.repository }}/releases/download/dev/zlib-dev-1.2.13-1-x86_64.pkg.tar.zst
          pacman -U *.zst --noconfirm
          sudo chmod 777 -R ${{ env.top_dir }}
          cd ${{ env.top_dir }}/toolchain-test/libpng-dev
          sudo -H -u builder makepkg-cross -sC --noconfirm
      - name: Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd ${{ env.top_dir }}/toolchain-test
          chmod +x ./release-dev.sh
          ./release-dev.sh libpng-dev libpng-dev
          
  zlib:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:base-devel
    steps:    
      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git yasm nasm ninja cmake python-pip curl python-cairo unzip p7zip curl jq
          pip3 install -U --break-system-packages setuptools rst2pdf mako jsonschema meson
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true
          git config --global rebase.autoStash true
          git config --global fetch.prune true
          git config --global --add safe.directory $PWD
      - name: Add builder user
        run: |
          useradd builder -m
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
      - name: Setting top_dir env
        run: |
           echo "top_dir=$(cd ~ && pwd)" >> $GITHUB_ENV         
      - name: Checkout
        run: |
          cd ${{ env.top_dir }}
          git clone https://github.com/eko5624/toolchain-test
      - name: Setting makepkg etc
        run: |
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg_cross.conf /etc
          sudo cp ${{ env.top_dir }}/toolchain-test/pacman-config/makepkg-cross /usr/local/bin
          sudo chmod +x /usr/local/bin/makepkg-cross
      - name: Loading cross gcc cache
        uses: actions/cache/restore@main
        with:
          path: ${{ env.top_dir }}/cross
          key: cross-gcc-mcf-${{ github.run_id }}
          restore-keys: |
            cross-gcc-mcf-
      - name: Build
        run: |
          export PATH="${{ env.top_dir }}/cross/bin:$PATH"
          export PKG_CONFIG_LIBDIR="${{ env.top_dir }}/opt/lib/pkgconfig"
          export PKG_CONFIG="pkgconf --static"

          sudo chmod 777 -R ${{ env.top_dir }}
          cd ${{ env.top_dir }}/toolchain-test/zlib-dev
          sudo -H -u builder makepkg-cross -sC --noconfirm
      - name: Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd ${{ env.top_dir }}/toolchain-test
          chmod +x ./release-dev.sh
          ./release-dev.sh zlib-dev zlib-dev
          
